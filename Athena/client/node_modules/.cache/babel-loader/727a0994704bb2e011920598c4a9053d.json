{"ast":null,"code":"'use strict';\n/*!\n * ws: a node.js websocket client\n * Copyright(c) 2011 Einar Otto Stangvik <einaros@gmail.com>\n * MIT Licensed\n */\n\nvar url = require('url'),\n    util = require('util'),\n    http = require('http'),\n    https = require('https'),\n    crypto = require('crypto'),\n    stream = require('stream'),\n    Ultron = require('ultron'),\n    Options = require('options'),\n    Sender = require('./Sender'),\n    Receiver = require('./Receiver'),\n    SenderHixie = require('./Sender.hixie'),\n    ReceiverHixie = require('./Receiver.hixie'),\n    Extensions = require('./Extensions'),\n    PerMessageDeflate = require('./PerMessageDeflate'),\n    EventEmitter = require('events').EventEmitter;\n/**\n * Constants\n */\n// Default protocol version\n\n\nvar protocolVersion = 13; // Close timeout\n\nvar closeTimeout = 30 * 1000; // Allow 30 seconds to terminate the connection cleanly\n\n/**\n * WebSocket implementation\n *\n * @constructor\n * @param {String} address Connection address.\n * @param {String|Array} protocols WebSocket protocols.\n * @param {Object} options Additional connection options.\n * @api public\n */\n\nfunction WebSocket(address, protocols, options) {\n  if (this instanceof WebSocket === false) {\n    return new WebSocket(address, protocols, options);\n  }\n\n  EventEmitter.call(this);\n\n  if (protocols && !Array.isArray(protocols) && 'object' === typeof protocols) {\n    // accept the \"options\" Object as the 2nd argument\n    options = protocols;\n    protocols = null;\n  }\n\n  if ('string' === typeof protocols) {\n    protocols = [protocols];\n  }\n\n  if (!Array.isArray(protocols)) {\n    protocols = [];\n  }\n\n  this._socket = null;\n  this._ultron = null;\n  this._closeReceived = false;\n  this.bytesReceived = 0;\n  this.readyState = null;\n  this.supports = {};\n  this.extensions = {};\n  this._binaryType = 'nodebuffer';\n\n  if (Array.isArray(address)) {\n    initAsServerClient.apply(this, address.concat(options));\n  } else {\n    initAsClient.apply(this, [address, protocols, options]);\n  }\n}\n/**\n * Inherits from EventEmitter.\n */\n\n\nutil.inherits(WebSocket, EventEmitter);\n/**\n * Ready States\n */\n\n[\"CONNECTING\", \"OPEN\", \"CLOSING\", \"CLOSED\"].forEach(function each(state, index) {\n  WebSocket.prototype[state] = WebSocket[state] = index;\n});\n/**\n * Gracefully closes the connection, after sending a description message to the server\n *\n * @param {Object} data to be sent to the server\n * @api public\n */\n\nWebSocket.prototype.close = function close(code, data) {\n  if (this.readyState === WebSocket.CLOSED) return;\n\n  if (this.readyState === WebSocket.CONNECTING) {\n    this.readyState = WebSocket.CLOSED;\n    return;\n  }\n\n  if (this.readyState === WebSocket.CLOSING) {\n    if (this._closeReceived && this._isServer) {\n      this.terminate();\n    }\n\n    return;\n  }\n\n  var self = this;\n\n  try {\n    this.readyState = WebSocket.CLOSING;\n    this._closeCode = code;\n    this._closeMessage = data;\n    var mask = !this._isServer;\n\n    this._sender.close(code, data, mask, function (err) {\n      if (err) self.emit('error', err);\n\n      if (self._closeReceived && self._isServer) {\n        self.terminate();\n      } else {\n        // ensure that the connection is cleaned up even when no response of closing handshake.\n        clearTimeout(self._closeTimer);\n        self._closeTimer = setTimeout(cleanupWebsocketResources.bind(self, true), closeTimeout);\n      }\n    });\n  } catch (e) {\n    this.emit('error', e);\n  }\n};\n/**\n * Pause the client stream\n *\n * @api public\n */\n\n\nWebSocket.prototype.pause = function pauser() {\n  if (this.readyState !== WebSocket.OPEN) throw new Error('not opened');\n  return this._socket.pause();\n};\n/**\n * Sends a ping\n *\n * @param {Object} data to be sent to the server\n * @param {Object} Members - mask: boolean, binary: boolean\n * @param {boolean} dontFailWhenClosed indicates whether or not to throw if the connection isnt open\n * @api public\n */\n\n\nWebSocket.prototype.ping = function ping(data, options, dontFailWhenClosed) {\n  if (this.readyState !== WebSocket.OPEN) {\n    if (dontFailWhenClosed === true) return;\n    throw new Error('not opened');\n  }\n\n  options = options || {};\n  if (typeof options.mask === 'undefined') options.mask = !this._isServer;\n\n  this._sender.ping(data, options);\n};\n/**\n * Sends a pong\n *\n * @param {Object} data to be sent to the server\n * @param {Object} Members - mask: boolean, binary: boolean\n * @param {boolean} dontFailWhenClosed indicates whether or not to throw if the connection isnt open\n * @api public\n */\n\n\nWebSocket.prototype.pong = function (data, options, dontFailWhenClosed) {\n  if (this.readyState !== WebSocket.OPEN) {\n    if (dontFailWhenClosed === true) return;\n    throw new Error('not opened');\n  }\n\n  options = options || {};\n  if (typeof options.mask === 'undefined') options.mask = !this._isServer;\n\n  this._sender.pong(data, options);\n};\n/**\n * Resume the client stream\n *\n * @api public\n */\n\n\nWebSocket.prototype.resume = function resume() {\n  if (this.readyState !== WebSocket.OPEN) throw new Error('not opened');\n  return this._socket.resume();\n};\n/**\n * Sends a piece of data\n *\n * @param {Object} data to be sent to the server\n * @param {Object} Members - mask: boolean, binary: boolean, compress: boolean\n * @param {function} Optional callback which is executed after the send completes\n * @api public\n */\n\n\nWebSocket.prototype.send = function send(data, options, cb) {\n  if (typeof options === 'function') {\n    cb = options;\n    options = {};\n  }\n\n  if (this.readyState !== WebSocket.OPEN) {\n    if (typeof cb === 'function') cb(new Error('not opened'));else throw new Error('not opened');\n    return;\n  }\n\n  if (!data) data = '';\n\n  if (this._queue) {\n    var self = this;\n\n    this._queue.push(function () {\n      self.send(data, options, cb);\n    });\n\n    return;\n  }\n\n  options = options || {};\n  options.fin = true;\n\n  if (typeof options.binary === 'undefined') {\n    options.binary = data instanceof ArrayBuffer || data instanceof Buffer || data instanceof Uint8Array || data instanceof Uint16Array || data instanceof Uint32Array || data instanceof Int8Array || data instanceof Int16Array || data instanceof Int32Array || data instanceof Float32Array || data instanceof Float64Array;\n  }\n\n  if (typeof options.mask === 'undefined') options.mask = !this._isServer;\n  if (typeof options.compress === 'undefined') options.compress = true;\n\n  if (!this.extensions[PerMessageDeflate.extensionName]) {\n    options.compress = false;\n  }\n\n  var readable = typeof stream.Readable === 'function' ? stream.Readable : stream.Stream;\n\n  if (data instanceof readable) {\n    startQueue(this);\n    var self = this;\n    sendStream(this, data, options, function send(error) {\n      process.nextTick(function tock() {\n        executeQueueSends(self);\n      });\n      if (typeof cb === 'function') cb(error);\n    });\n  } else {\n    this._sender.send(data, options, cb);\n  }\n};\n/**\n * Streams data through calls to a user supplied function\n *\n * @param {Object} Members - mask: boolean, binary: boolean, compress: boolean\n * @param {function} 'function (error, send)' which is executed on successive ticks of which send is 'function (data, final)'.\n * @api public\n */\n\n\nWebSocket.prototype.stream = function stream(options, cb) {\n  if (typeof options === 'function') {\n    cb = options;\n    options = {};\n  }\n\n  var self = this;\n  if (typeof cb !== 'function') throw new Error('callback must be provided');\n\n  if (this.readyState !== WebSocket.OPEN) {\n    if (typeof cb === 'function') cb(new Error('not opened'));else throw new Error('not opened');\n    return;\n  }\n\n  if (this._queue) {\n    this._queue.push(function () {\n      self.stream(options, cb);\n    });\n\n    return;\n  }\n\n  options = options || {};\n  if (typeof options.mask === 'undefined') options.mask = !this._isServer;\n  if (typeof options.compress === 'undefined') options.compress = true;\n\n  if (!this.extensions[PerMessageDeflate.extensionName]) {\n    options.compress = false;\n  }\n\n  startQueue(this);\n\n  function send(data, final) {\n    try {\n      if (self.readyState !== WebSocket.OPEN) throw new Error('not opened');\n      options.fin = final === true;\n\n      self._sender.send(data, options);\n\n      if (!final) process.nextTick(cb.bind(null, null, send));else executeQueueSends(self);\n    } catch (e) {\n      if (typeof cb === 'function') cb(e);else {\n        delete self._queue;\n        self.emit('error', e);\n      }\n    }\n  }\n\n  process.nextTick(cb.bind(null, null, send));\n};\n/**\n * Immediately shuts down the connection\n *\n * @api public\n */\n\n\nWebSocket.prototype.terminate = function terminate() {\n  if (this.readyState === WebSocket.CLOSED) return;\n\n  if (this._socket) {\n    this.readyState = WebSocket.CLOSING; // End the connection\n\n    try {\n      this._socket.end();\n    } catch (e) {\n      // Socket error during end() call, so just destroy it right now\n      cleanupWebsocketResources.call(this, true);\n      return;\n    } // Add a timeout to ensure that the connection is completely\n    // cleaned up within 30 seconds, even if the clean close procedure\n    // fails for whatever reason\n    // First cleanup any pre-existing timeout from an earlier \"terminate\" call,\n    // if one exists.  Otherwise terminate calls in quick succession will leak timeouts\n    // and hold the program open for `closeTimout` time.\n\n\n    if (this._closeTimer) {\n      clearTimeout(this._closeTimer);\n    }\n\n    this._closeTimer = setTimeout(cleanupWebsocketResources.bind(this, true), closeTimeout);\n  } else if (this.readyState === WebSocket.CONNECTING) {\n    cleanupWebsocketResources.call(this, true);\n  }\n};\n/**\n * Expose bufferedAmount\n *\n * @api public\n */\n\n\nObject.defineProperty(WebSocket.prototype, 'bufferedAmount', {\n  get: function get() {\n    var amount = 0;\n\n    if (this._socket) {\n      amount = this._socket.bufferSize || 0;\n    }\n\n    return amount;\n  }\n});\n/**\n * Expose binaryType\n *\n * This deviates from the W3C interface since ws doesn't support the required\n * default \"blob\" type (instead we define a custom \"nodebuffer\" type).\n *\n * @see http://dev.w3.org/html5/websockets/#the-websocket-interface\n * @api public\n */\n\nObject.defineProperty(WebSocket.prototype, 'binaryType', {\n  get: function get() {\n    return this._binaryType;\n  },\n  set: function set(type) {\n    if (type === 'arraybuffer' || type === 'nodebuffer') this._binaryType = type;else throw new SyntaxError('unsupported binaryType: must be either \"nodebuffer\" or \"arraybuffer\"');\n  }\n});\n/**\n * Emulates the W3C Browser based WebSocket interface using function members.\n *\n * @see http://dev.w3.org/html5/websockets/#the-websocket-interface\n * @api public\n */\n\n['open', 'error', 'close', 'message'].forEach(function (method) {\n  Object.defineProperty(WebSocket.prototype, 'on' + method, {\n    /**\n     * Returns the current listener\n     *\n     * @returns {Mixed} the set function or undefined\n     * @api public\n     */\n    get: function get() {\n      var listener = this.listeners(method)[0];\n      return listener ? listener._listener ? listener._listener : listener : undefined;\n    },\n\n    /**\n     * Start listening for events\n     *\n     * @param {Function} listener the listener\n     * @returns {Mixed} the set function or undefined\n     * @api public\n     */\n    set: function set(listener) {\n      this.removeAllListeners(method);\n      this.addEventListener(method, listener);\n    }\n  });\n});\n/**\n * Emulates the W3C Browser based WebSocket interface using addEventListener.\n *\n * @see https://developer.mozilla.org/en/DOM/element.addEventListener\n * @see http://dev.w3.org/html5/websockets/#the-websocket-interface\n * @api public\n */\n\nWebSocket.prototype.addEventListener = function (method, listener) {\n  var target = this;\n\n  function onMessage(data, flags) {\n    if (flags.binary && this.binaryType === 'arraybuffer') data = new Uint8Array(data).buffer;\n    listener.call(target, new MessageEvent(data, !!flags.binary, target));\n  }\n\n  function onClose(code, message) {\n    listener.call(target, new CloseEvent(code, message, target));\n  }\n\n  function onError(event) {\n    event.type = 'error';\n    event.target = target;\n    listener.call(target, event);\n  }\n\n  function onOpen() {\n    listener.call(target, new OpenEvent(target));\n  }\n\n  if (typeof listener === 'function') {\n    if (method === 'message') {\n      // store a reference so we can return the original function from the\n      // addEventListener hook\n      onMessage._listener = listener;\n      this.on(method, onMessage);\n    } else if (method === 'close') {\n      // store a reference so we can return the original function from the\n      // addEventListener hook\n      onClose._listener = listener;\n      this.on(method, onClose);\n    } else if (method === 'error') {\n      // store a reference so we can return the original function from the\n      // addEventListener hook\n      onError._listener = listener;\n      this.on(method, onError);\n    } else if (method === 'open') {\n      // store a reference so we can return the original function from the\n      // addEventListener hook\n      onOpen._listener = listener;\n      this.on(method, onOpen);\n    } else {\n      this.on(method, listener);\n    }\n  }\n};\n\nmodule.exports = WebSocket;\nmodule.exports.buildHostHeader = buildHostHeader;\n/**\n * W3C MessageEvent\n *\n * @see http://www.w3.org/TR/html5/comms.html\n * @constructor\n * @api private\n */\n\nfunction MessageEvent(dataArg, isBinary, target) {\n  this.type = 'message';\n  this.data = dataArg;\n  this.target = target;\n  this.binary = isBinary; // non-standard.\n}\n/**\n * W3C CloseEvent\n *\n * @see http://www.w3.org/TR/html5/comms.html\n * @constructor\n * @api private\n */\n\n\nfunction CloseEvent(code, reason, target) {\n  this.type = 'close';\n  this.wasClean = typeof code === 'undefined' || code === 1000;\n  this.code = code;\n  this.reason = reason;\n  this.target = target;\n}\n/**\n * W3C OpenEvent\n *\n * @see http://www.w3.org/TR/html5/comms.html\n * @constructor\n * @api private\n */\n\n\nfunction OpenEvent(target) {\n  this.type = 'open';\n  this.target = target;\n} // Append port number to Host header, only if specified in the url\n// and non-default\n\n\nfunction buildHostHeader(isSecure, hostname, port) {\n  var headerHost = hostname;\n\n  if (hostname) {\n    if (isSecure && port != 443 || !isSecure && port != 80) {\n      headerHost = headerHost + ':' + port;\n    }\n  }\n\n  return headerHost;\n}\n/**\n * Entirely private apis,\n * which may or may not be bound to a sepcific WebSocket instance.\n */\n\n\nfunction initAsServerClient(req, socket, upgradeHead, options) {\n  options = new Options({\n    protocolVersion: protocolVersion,\n    protocol: null,\n    extensions: {},\n    maxPayload: 0\n  }).merge(options); // expose state properties\n\n  this.protocol = options.value.protocol;\n  this.protocolVersion = options.value.protocolVersion;\n  this.extensions = options.value.extensions;\n  this.supports.binary = this.protocolVersion !== 'hixie-76';\n  this.upgradeReq = req;\n  this.readyState = WebSocket.CONNECTING;\n  this._isServer = true;\n  this.maxPayload = options.value.maxPayload; // establish connection\n\n  if (options.value.protocolVersion === 'hixie-76') {\n    establishConnection.call(this, ReceiverHixie, SenderHixie, socket, upgradeHead);\n  } else {\n    establishConnection.call(this, Receiver, Sender, socket, upgradeHead);\n  }\n}\n\nfunction initAsClient(address, protocols, options) {\n  options = new Options({\n    origin: null,\n    protocolVersion: protocolVersion,\n    host: null,\n    headers: null,\n    protocol: protocols.join(','),\n    agent: null,\n    // ssl-related options\n    pfx: null,\n    key: null,\n    passphrase: null,\n    cert: null,\n    ca: null,\n    ciphers: null,\n    rejectUnauthorized: null,\n    perMessageDeflate: true,\n    localAddress: null\n  }).merge(options);\n\n  if (options.value.protocolVersion !== 8 && options.value.protocolVersion !== 13) {\n    throw new Error('unsupported protocol version');\n  } // verify URL and establish http class\n\n\n  var serverUrl = url.parse(address);\n  var isUnixSocket = serverUrl.protocol === 'ws+unix:';\n  if (!serverUrl.host && !isUnixSocket) throw new Error('invalid url');\n  var isSecure = serverUrl.protocol === 'wss:' || serverUrl.protocol === 'https:';\n  var httpObj = isSecure ? https : http;\n  var port = serverUrl.port || (isSecure ? 443 : 80);\n  var auth = serverUrl.auth; // prepare extensions\n\n  var extensionsOffer = {};\n  var perMessageDeflate;\n\n  if (options.value.perMessageDeflate) {\n    perMessageDeflate = new PerMessageDeflate(typeof options.value.perMessageDeflate !== true ? options.value.perMessageDeflate : {}, false);\n    extensionsOffer[PerMessageDeflate.extensionName] = perMessageDeflate.offer();\n  } // expose state properties\n\n\n  this._isServer = false;\n  this.url = address;\n  this.protocolVersion = options.value.protocolVersion;\n  this.supports.binary = this.protocolVersion !== 'hixie-76'; // begin handshake\n\n  var key = new Buffer(options.value.protocolVersion + '-' + Date.now()).toString('base64');\n  var shasum = crypto.createHash('sha1');\n  shasum.update(key + '258EAFA5-E914-47DA-95CA-C5AB0DC85B11');\n  var expectedServerKey = shasum.digest('base64');\n  var agent = options.value.agent;\n  var headerHost = buildHostHeader(isSecure, serverUrl.hostname, port);\n  var requestOptions = {\n    port: port,\n    host: serverUrl.hostname,\n    headers: {\n      'Connection': 'Upgrade',\n      'Upgrade': 'websocket',\n      'Host': headerHost,\n      'Sec-WebSocket-Version': options.value.protocolVersion,\n      'Sec-WebSocket-Key': key\n    }\n  }; // If we have basic auth.\n\n  if (auth) {\n    requestOptions.headers.Authorization = 'Basic ' + new Buffer(auth).toString('base64');\n  }\n\n  if (options.value.protocol) {\n    requestOptions.headers['Sec-WebSocket-Protocol'] = options.value.protocol;\n  }\n\n  if (options.value.host) {\n    requestOptions.headers.Host = options.value.host;\n  }\n\n  if (options.value.headers) {\n    for (var header in options.value.headers) {\n      if (options.value.headers.hasOwnProperty(header)) {\n        requestOptions.headers[header] = options.value.headers[header];\n      }\n    }\n  }\n\n  if (Object.keys(extensionsOffer).length) {\n    requestOptions.headers['Sec-WebSocket-Extensions'] = Extensions.format(extensionsOffer);\n  }\n\n  if (options.isDefinedAndNonNull('pfx') || options.isDefinedAndNonNull('key') || options.isDefinedAndNonNull('passphrase') || options.isDefinedAndNonNull('cert') || options.isDefinedAndNonNull('ca') || options.isDefinedAndNonNull('ciphers') || options.isDefinedAndNonNull('rejectUnauthorized')) {\n    if (options.isDefinedAndNonNull('pfx')) requestOptions.pfx = options.value.pfx;\n    if (options.isDefinedAndNonNull('key')) requestOptions.key = options.value.key;\n    if (options.isDefinedAndNonNull('passphrase')) requestOptions.passphrase = options.value.passphrase;\n    if (options.isDefinedAndNonNull('cert')) requestOptions.cert = options.value.cert;\n    if (options.isDefinedAndNonNull('ca')) requestOptions.ca = options.value.ca;\n    if (options.isDefinedAndNonNull('ciphers')) requestOptions.ciphers = options.value.ciphers;\n    if (options.isDefinedAndNonNull('rejectUnauthorized')) requestOptions.rejectUnauthorized = options.value.rejectUnauthorized;\n\n    if (!agent) {\n      // global agent ignores client side certificates\n      agent = new httpObj.Agent(requestOptions);\n    }\n  }\n\n  requestOptions.path = serverUrl.path || '/';\n\n  if (agent) {\n    requestOptions.agent = agent;\n  }\n\n  if (isUnixSocket) {\n    requestOptions.socketPath = serverUrl.pathname;\n  }\n\n  if (options.value.localAddress) {\n    requestOptions.localAddress = options.value.localAddress;\n  }\n\n  if (options.value.origin) {\n    if (options.value.protocolVersion < 13) requestOptions.headers['Sec-WebSocket-Origin'] = options.value.origin;else requestOptions.headers.Origin = options.value.origin;\n  }\n\n  var self = this;\n  var req = httpObj.request(requestOptions);\n  req.on('error', function onerror(error) {\n    self.emit('error', error);\n    cleanupWebsocketResources.call(self, error);\n  });\n  req.once('response', function response(res) {\n    var error;\n\n    if (!self.emit('unexpected-response', req, res)) {\n      error = new Error('unexpected server response (' + res.statusCode + ')');\n      req.abort();\n      self.emit('error', error);\n    }\n\n    cleanupWebsocketResources.call(self, error);\n  });\n  req.once('upgrade', function upgrade(res, socket, upgradeHead) {\n    if (self.readyState === WebSocket.CLOSED) {\n      // client closed before server accepted connection\n      self.emit('close');\n      self.removeAllListeners();\n      socket.end();\n      return;\n    }\n\n    var serverKey = res.headers['sec-websocket-accept'];\n\n    if (typeof serverKey === 'undefined' || serverKey !== expectedServerKey) {\n      self.emit('error', 'invalid server key');\n      self.removeAllListeners();\n      socket.end();\n      return;\n    }\n\n    var serverProt = res.headers['sec-websocket-protocol'];\n    var protList = (options.value.protocol || \"\").split(/, */);\n    var protError = null;\n\n    if (!options.value.protocol && serverProt) {\n      protError = 'server sent a subprotocol even though none requested';\n    } else if (options.value.protocol && !serverProt) {\n      protError = 'server sent no subprotocol even though requested';\n    } else if (serverProt && protList.indexOf(serverProt) === -1) {\n      protError = 'server responded with an invalid protocol';\n    }\n\n    if (protError) {\n      self.emit('error', protError);\n      self.removeAllListeners();\n      socket.end();\n      return;\n    } else if (serverProt) {\n      self.protocol = serverProt;\n    }\n\n    var serverExtensions = Extensions.parse(res.headers['sec-websocket-extensions']);\n\n    if (perMessageDeflate && serverExtensions[PerMessageDeflate.extensionName]) {\n      try {\n        perMessageDeflate.accept(serverExtensions[PerMessageDeflate.extensionName]);\n      } catch (err) {\n        self.emit('error', 'invalid extension parameter');\n        self.removeAllListeners();\n        socket.end();\n        return;\n      }\n\n      self.extensions[PerMessageDeflate.extensionName] = perMessageDeflate;\n    }\n\n    establishConnection.call(self, Receiver, Sender, socket, upgradeHead); // perform cleanup on http resources\n\n    req.removeAllListeners();\n    req = null;\n    agent = null;\n  });\n  req.end();\n  this.readyState = WebSocket.CONNECTING;\n}\n\nfunction establishConnection(ReceiverClass, SenderClass, socket, upgradeHead) {\n  var ultron = this._ultron = new Ultron(socket),\n      called = false,\n      self = this;\n  socket.setTimeout(0);\n  socket.setNoDelay(true);\n  this._receiver = new ReceiverClass(this.extensions, this.maxPayload);\n  this._socket = socket; // socket cleanup handlers\n\n  ultron.on('end', cleanupWebsocketResources.bind(this));\n  ultron.on('close', cleanupWebsocketResources.bind(this));\n  ultron.on('error', cleanupWebsocketResources.bind(this)); // ensure that the upgradeHead is added to the receiver\n\n  function firstHandler(data) {\n    if (called || self.readyState === WebSocket.CLOSED) return;\n    called = true;\n    socket.removeListener('data', firstHandler);\n    ultron.on('data', realHandler);\n\n    if (upgradeHead && upgradeHead.length > 0) {\n      realHandler(upgradeHead);\n      upgradeHead = null;\n    }\n\n    if (data) realHandler(data);\n  } // subsequent packets are pushed straight to the receiver\n\n\n  function realHandler(data) {\n    self.bytesReceived += data.length;\n\n    self._receiver.add(data);\n  }\n\n  ultron.on('data', firstHandler); // if data was passed along with the http upgrade,\n  // this will schedule a push of that on to the receiver.\n  // this has to be done on next tick, since the caller\n  // hasn't had a chance to set event handlers on this client\n  // object yet.\n\n  process.nextTick(firstHandler); // receiver event handlers\n\n  self._receiver.ontext = function ontext(data, flags) {\n    flags = flags || {};\n    self.emit('message', data, flags);\n  };\n\n  self._receiver.onbinary = function onbinary(data, flags) {\n    flags = flags || {};\n    flags.binary = true;\n    self.emit('message', data, flags);\n  };\n\n  self._receiver.onping = function onping(data, flags) {\n    flags = flags || {};\n    self.pong(data, {\n      mask: !self._isServer,\n      binary: flags.binary === true\n    }, true);\n    self.emit('ping', data, flags);\n  };\n\n  self._receiver.onpong = function onpong(data, flags) {\n    self.emit('pong', data, flags || {});\n  };\n\n  self._receiver.onclose = function onclose(code, data, flags) {\n    flags = flags || {};\n    self._closeReceived = true;\n    self.close(code, data);\n  };\n\n  self._receiver.onerror = function onerror(reason, errorCode) {\n    // close the connection when the receiver reports a HyBi error code\n    self.close(typeof errorCode !== 'undefined' ? errorCode : 1002, '');\n    self.emit('error', reason instanceof Error ? reason : new Error(reason));\n  }; // finalize the client\n\n\n  this._sender = new SenderClass(socket, this.extensions);\n\n  this._sender.on('error', function onerror(error) {\n    self.close(1002, '');\n    self.emit('error', error);\n  });\n\n  this.readyState = WebSocket.OPEN;\n  this.emit('open');\n}\n\nfunction startQueue(instance) {\n  instance._queue = instance._queue || [];\n}\n\nfunction executeQueueSends(instance) {\n  var queue = instance._queue;\n  if (typeof queue === 'undefined') return;\n  delete instance._queue;\n\n  for (var i = 0, l = queue.length; i < l; ++i) {\n    queue[i]();\n  }\n}\n\nfunction sendStream(instance, stream, options, cb) {\n  stream.on('data', function incoming(data) {\n    if (instance.readyState !== WebSocket.OPEN) {\n      if (typeof cb === 'function') cb(new Error('not opened'));else {\n        delete instance._queue;\n        instance.emit('error', new Error('not opened'));\n      }\n      return;\n    }\n\n    options.fin = false;\n\n    instance._sender.send(data, options);\n  });\n  stream.on('end', function end() {\n    if (instance.readyState !== WebSocket.OPEN) {\n      if (typeof cb === 'function') cb(new Error('not opened'));else {\n        delete instance._queue;\n        instance.emit('error', new Error('not opened'));\n      }\n      return;\n    }\n\n    options.fin = true;\n\n    instance._sender.send(null, options);\n\n    if (typeof cb === 'function') cb(null);\n  });\n}\n\nfunction cleanupWebsocketResources(error) {\n  if (this.readyState === WebSocket.CLOSED) return;\n  this.readyState = WebSocket.CLOSED;\n  clearTimeout(this._closeTimer);\n  this._closeTimer = null; // If the connection was closed abnormally (with an error), or if\n  // the close control frame was not received then the close code\n  // must default to 1006.\n\n  if (error || !this._closeReceived) {\n    this._closeCode = 1006;\n  }\n\n  this.emit('close', this._closeCode || 1000, this._closeMessage || '');\n\n  if (this._socket) {\n    if (this._ultron) this._ultron.destroy();\n\n    this._socket.on('error', function onerror() {\n      try {\n        this.destroy();\n      } catch (e) {}\n    });\n\n    try {\n      if (!error) this._socket.end();else this._socket.destroy();\n    } catch (e) {\n      /* Ignore termination errors */\n    }\n\n    this._socket = null;\n    this._ultron = null;\n  }\n\n  if (this._sender) {\n    this._sender.removeAllListeners();\n\n    this._sender = null;\n  }\n\n  if (this._receiver) {\n    this._receiver.cleanup();\n\n    this._receiver = null;\n  }\n\n  if (this.extensions[PerMessageDeflate.extensionName]) {\n    this.extensions[PerMessageDeflate.extensionName].cleanup();\n  }\n\n  this.extensions = null;\n  this.removeAllListeners();\n  this.on('error', function onerror() {}); // catch all errors after this\n\n  delete this._queue;\n}","map":{"version":3,"sources":["/home/subho/Programming/Internet-Technology/Athena/node_modules/ws/lib/WebSocket.js"],"names":["url","require","util","http","https","crypto","stream","Ultron","Options","Sender","Receiver","SenderHixie","ReceiverHixie","Extensions","PerMessageDeflate","EventEmitter","protocolVersion","closeTimeout","WebSocket","address","protocols","options","call","Array","isArray","_socket","_ultron","_closeReceived","bytesReceived","readyState","supports","extensions","_binaryType","initAsServerClient","apply","concat","initAsClient","inherits","forEach","each","state","index","prototype","close","code","data","CLOSED","CONNECTING","CLOSING","_isServer","terminate","self","_closeCode","_closeMessage","mask","_sender","err","emit","clearTimeout","_closeTimer","setTimeout","cleanupWebsocketResources","bind","e","pause","pauser","OPEN","Error","ping","dontFailWhenClosed","pong","resume","send","cb","_queue","push","fin","binary","ArrayBuffer","Buffer","Uint8Array","Uint16Array","Uint32Array","Int8Array","Int16Array","Int32Array","Float32Array","Float64Array","compress","extensionName","readable","Readable","Stream","startQueue","sendStream","error","process","nextTick","tock","executeQueueSends","final","end","Object","defineProperty","get","amount","bufferSize","set","type","SyntaxError","method","listener","listeners","_listener","undefined","removeAllListeners","addEventListener","target","onMessage","flags","binaryType","buffer","MessageEvent","onClose","message","CloseEvent","onError","event","onOpen","OpenEvent","on","module","exports","buildHostHeader","dataArg","isBinary","reason","wasClean","isSecure","hostname","port","headerHost","req","socket","upgradeHead","protocol","maxPayload","merge","value","upgradeReq","establishConnection","origin","host","headers","join","agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","perMessageDeflate","localAddress","serverUrl","parse","isUnixSocket","httpObj","auth","extensionsOffer","offer","Date","now","toString","shasum","createHash","update","expectedServerKey","digest","requestOptions","Authorization","Host","header","hasOwnProperty","keys","length","format","isDefinedAndNonNull","Agent","path","socketPath","pathname","Origin","request","onerror","once","response","res","statusCode","abort","upgrade","serverKey","serverProt","protList","split","protError","indexOf","serverExtensions","accept","ReceiverClass","SenderClass","ultron","called","setNoDelay","_receiver","firstHandler","removeListener","realHandler","add","ontext","onbinary","onping","onpong","onclose","errorCode","instance","queue","i","l","incoming","destroy","cleanup"],"mappings":"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","sourcesContent":["'use strict';\n\n/*!\n * ws: a node.js websocket client\n * Copyright(c) 2011 Einar Otto Stangvik <einaros@gmail.com>\n * MIT Licensed\n */\n\nvar url = require('url')\n  , util = require('util')\n  , http = require('http')\n  , https = require('https')\n  , crypto = require('crypto')\n  , stream = require('stream')\n  , Ultron = require('ultron')\n  , Options = require('options')\n  , Sender = require('./Sender')\n  , Receiver = require('./Receiver')\n  , SenderHixie = require('./Sender.hixie')\n  , ReceiverHixie = require('./Receiver.hixie')\n  , Extensions = require('./Extensions')\n  , PerMessageDeflate = require('./PerMessageDeflate')\n  , EventEmitter = require('events').EventEmitter;\n\n/**\n * Constants\n */\n\n// Default protocol version\n\nvar protocolVersion = 13;\n\n// Close timeout\n\nvar closeTimeout = 30 * 1000; // Allow 30 seconds to terminate the connection cleanly\n\n/**\n * WebSocket implementation\n *\n * @constructor\n * @param {String} address Connection address.\n * @param {String|Array} protocols WebSocket protocols.\n * @param {Object} options Additional connection options.\n * @api public\n */\nfunction WebSocket(address, protocols, options) {\n  if (this instanceof WebSocket === false) {\n    return new WebSocket(address, protocols, options);\n  }\n\n  EventEmitter.call(this);\n\n  if (protocols && !Array.isArray(protocols) && 'object' === typeof protocols) {\n    // accept the \"options\" Object as the 2nd argument\n    options = protocols;\n    protocols = null;\n  }\n\n  if ('string' === typeof protocols) {\n    protocols = [ protocols ];\n  }\n\n  if (!Array.isArray(protocols)) {\n    protocols = [];\n  }\n\n  this._socket = null;\n  this._ultron = null;\n  this._closeReceived = false;\n  this.bytesReceived = 0;\n  this.readyState = null;\n  this.supports = {};\n  this.extensions = {};\n  this._binaryType = 'nodebuffer';\n\n  if (Array.isArray(address)) {\n    initAsServerClient.apply(this, address.concat(options));\n  } else {\n    initAsClient.apply(this, [address, protocols, options]);\n  }\n}\n\n/**\n * Inherits from EventEmitter.\n */\nutil.inherits(WebSocket, EventEmitter);\n\n/**\n * Ready States\n */\n[\"CONNECTING\", \"OPEN\", \"CLOSING\", \"CLOSED\"].forEach(function each(state, index) {\n    WebSocket.prototype[state] = WebSocket[state] = index;\n});\n\n/**\n * Gracefully closes the connection, after sending a description message to the server\n *\n * @param {Object} data to be sent to the server\n * @api public\n */\nWebSocket.prototype.close = function close(code, data) {\n  if (this.readyState === WebSocket.CLOSED) return;\n\n  if (this.readyState === WebSocket.CONNECTING) {\n    this.readyState = WebSocket.CLOSED;\n    return;\n  }\n\n  if (this.readyState === WebSocket.CLOSING) {\n    if (this._closeReceived && this._isServer) {\n      this.terminate();\n    }\n    return;\n  }\n\n  var self = this;\n  try {\n    this.readyState = WebSocket.CLOSING;\n    this._closeCode = code;\n    this._closeMessage = data;\n    var mask = !this._isServer;\n    this._sender.close(code, data, mask, function(err) {\n      if (err) self.emit('error', err);\n\n      if (self._closeReceived && self._isServer) {\n        self.terminate();\n      } else {\n        // ensure that the connection is cleaned up even when no response of closing handshake.\n        clearTimeout(self._closeTimer);\n        self._closeTimer = setTimeout(cleanupWebsocketResources.bind(self, true), closeTimeout);\n      }\n    });\n  } catch (e) {\n    this.emit('error', e);\n  }\n};\n\n/**\n * Pause the client stream\n *\n * @api public\n */\nWebSocket.prototype.pause = function pauser() {\n  if (this.readyState !== WebSocket.OPEN) throw new Error('not opened');\n\n  return this._socket.pause();\n};\n\n/**\n * Sends a ping\n *\n * @param {Object} data to be sent to the server\n * @param {Object} Members - mask: boolean, binary: boolean\n * @param {boolean} dontFailWhenClosed indicates whether or not to throw if the connection isnt open\n * @api public\n */\nWebSocket.prototype.ping = function ping(data, options, dontFailWhenClosed) {\n  if (this.readyState !== WebSocket.OPEN) {\n    if (dontFailWhenClosed === true) return;\n    throw new Error('not opened');\n  }\n\n  options = options || {};\n\n  if (typeof options.mask === 'undefined') options.mask = !this._isServer;\n\n  this._sender.ping(data, options);\n};\n\n/**\n * Sends a pong\n *\n * @param {Object} data to be sent to the server\n * @param {Object} Members - mask: boolean, binary: boolean\n * @param {boolean} dontFailWhenClosed indicates whether or not to throw if the connection isnt open\n * @api public\n */\nWebSocket.prototype.pong = function(data, options, dontFailWhenClosed) {\n  if (this.readyState !== WebSocket.OPEN) {\n    if (dontFailWhenClosed === true) return;\n    throw new Error('not opened');\n  }\n\n  options = options || {};\n\n  if (typeof options.mask === 'undefined') options.mask = !this._isServer;\n\n  this._sender.pong(data, options);\n};\n\n/**\n * Resume the client stream\n *\n * @api public\n */\nWebSocket.prototype.resume = function resume() {\n  if (this.readyState !== WebSocket.OPEN) throw new Error('not opened');\n\n  return this._socket.resume();\n};\n\n/**\n * Sends a piece of data\n *\n * @param {Object} data to be sent to the server\n * @param {Object} Members - mask: boolean, binary: boolean, compress: boolean\n * @param {function} Optional callback which is executed after the send completes\n * @api public\n */\n\nWebSocket.prototype.send = function send(data, options, cb) {\n  if (typeof options === 'function') {\n    cb = options;\n    options = {};\n  }\n\n  if (this.readyState !== WebSocket.OPEN) {\n    if (typeof cb === 'function') cb(new Error('not opened'));\n    else throw new Error('not opened');\n    return;\n  }\n\n  if (!data) data = '';\n  if (this._queue) {\n    var self = this;\n    this._queue.push(function() { self.send(data, options, cb); });\n    return;\n  }\n\n  options = options || {};\n  options.fin = true;\n\n  if (typeof options.binary === 'undefined') {\n    options.binary = (data instanceof ArrayBuffer || data instanceof Buffer ||\n      data instanceof Uint8Array ||\n      data instanceof Uint16Array ||\n      data instanceof Uint32Array ||\n      data instanceof Int8Array ||\n      data instanceof Int16Array ||\n      data instanceof Int32Array ||\n      data instanceof Float32Array ||\n      data instanceof Float64Array);\n  }\n\n  if (typeof options.mask === 'undefined') options.mask = !this._isServer;\n  if (typeof options.compress === 'undefined') options.compress = true;\n  if (!this.extensions[PerMessageDeflate.extensionName]) {\n    options.compress = false;\n  }\n\n  var readable = typeof stream.Readable === 'function'\n    ? stream.Readable\n    : stream.Stream;\n\n  if (data instanceof readable) {\n    startQueue(this);\n    var self = this;\n\n    sendStream(this, data, options, function send(error) {\n      process.nextTick(function tock() {\n        executeQueueSends(self);\n      });\n\n      if (typeof cb === 'function') cb(error);\n    });\n  } else {\n    this._sender.send(data, options, cb);\n  }\n};\n\n/**\n * Streams data through calls to a user supplied function\n *\n * @param {Object} Members - mask: boolean, binary: boolean, compress: boolean\n * @param {function} 'function (error, send)' which is executed on successive ticks of which send is 'function (data, final)'.\n * @api public\n */\nWebSocket.prototype.stream = function stream(options, cb) {\n  if (typeof options === 'function') {\n    cb = options;\n    options = {};\n  }\n\n  var self = this;\n\n  if (typeof cb !== 'function') throw new Error('callback must be provided');\n\n  if (this.readyState !== WebSocket.OPEN) {\n    if (typeof cb === 'function') cb(new Error('not opened'));\n    else throw new Error('not opened');\n    return;\n  }\n\n  if (this._queue) {\n    this._queue.push(function () { self.stream(options, cb); });\n    return;\n  }\n\n  options = options || {};\n\n  if (typeof options.mask === 'undefined') options.mask = !this._isServer;\n  if (typeof options.compress === 'undefined') options.compress = true;\n  if (!this.extensions[PerMessageDeflate.extensionName]) {\n    options.compress = false;\n  }\n\n  startQueue(this);\n\n  function send(data, final) {\n    try {\n      if (self.readyState !== WebSocket.OPEN) throw new Error('not opened');\n      options.fin = final === true;\n      self._sender.send(data, options);\n      if (!final) process.nextTick(cb.bind(null, null, send));\n      else executeQueueSends(self);\n    } catch (e) {\n      if (typeof cb === 'function') cb(e);\n      else {\n        delete self._queue;\n        self.emit('error', e);\n      }\n    }\n  }\n\n  process.nextTick(cb.bind(null, null, send));\n};\n\n/**\n * Immediately shuts down the connection\n *\n * @api public\n */\nWebSocket.prototype.terminate = function terminate() {\n  if (this.readyState === WebSocket.CLOSED) return;\n\n  if (this._socket) {\n    this.readyState = WebSocket.CLOSING;\n\n    // End the connection\n    try { this._socket.end(); }\n    catch (e) {\n      // Socket error during end() call, so just destroy it right now\n      cleanupWebsocketResources.call(this, true);\n      return;\n    }\n\n    // Add a timeout to ensure that the connection is completely\n    // cleaned up within 30 seconds, even if the clean close procedure\n    // fails for whatever reason\n    // First cleanup any pre-existing timeout from an earlier \"terminate\" call,\n    // if one exists.  Otherwise terminate calls in quick succession will leak timeouts\n    // and hold the program open for `closeTimout` time.\n    if (this._closeTimer) { clearTimeout(this._closeTimer); }\n    this._closeTimer = setTimeout(cleanupWebsocketResources.bind(this, true), closeTimeout);\n  } else if (this.readyState === WebSocket.CONNECTING) {\n    cleanupWebsocketResources.call(this, true);\n  }\n};\n\n/**\n * Expose bufferedAmount\n *\n * @api public\n */\nObject.defineProperty(WebSocket.prototype, 'bufferedAmount', {\n  get: function get() {\n    var amount = 0;\n    if (this._socket) {\n      amount = this._socket.bufferSize || 0;\n    }\n    return amount;\n  }\n});\n\n/**\n * Expose binaryType\n *\n * This deviates from the W3C interface since ws doesn't support the required\n * default \"blob\" type (instead we define a custom \"nodebuffer\" type).\n *\n * @see http://dev.w3.org/html5/websockets/#the-websocket-interface\n * @api public\n */\nObject.defineProperty(WebSocket.prototype, 'binaryType', {\n  get: function get() {\n    return this._binaryType;\n  },\n  set: function set(type) {\n    if (type === 'arraybuffer' || type === 'nodebuffer')\n      this._binaryType = type;\n    else\n      throw new SyntaxError('unsupported binaryType: must be either \"nodebuffer\" or \"arraybuffer\"');\n  }\n});\n\n/**\n * Emulates the W3C Browser based WebSocket interface using function members.\n *\n * @see http://dev.w3.org/html5/websockets/#the-websocket-interface\n * @api public\n */\n['open', 'error', 'close', 'message'].forEach(function(method) {\n  Object.defineProperty(WebSocket.prototype, 'on' + method, {\n    /**\n     * Returns the current listener\n     *\n     * @returns {Mixed} the set function or undefined\n     * @api public\n     */\n    get: function get() {\n      var listener = this.listeners(method)[0];\n      return listener ? (listener._listener ? listener._listener : listener) : undefined;\n    },\n\n    /**\n     * Start listening for events\n     *\n     * @param {Function} listener the listener\n     * @returns {Mixed} the set function or undefined\n     * @api public\n     */\n    set: function set(listener) {\n      this.removeAllListeners(method);\n      this.addEventListener(method, listener);\n    }\n  });\n});\n\n/**\n * Emulates the W3C Browser based WebSocket interface using addEventListener.\n *\n * @see https://developer.mozilla.org/en/DOM/element.addEventListener\n * @see http://dev.w3.org/html5/websockets/#the-websocket-interface\n * @api public\n */\nWebSocket.prototype.addEventListener = function(method, listener) {\n  var target = this;\n\n  function onMessage (data, flags) {\n    if (flags.binary && this.binaryType === 'arraybuffer')\n        data = new Uint8Array(data).buffer;\n    listener.call(target, new MessageEvent(data, !!flags.binary, target));\n  }\n\n  function onClose (code, message) {\n    listener.call(target, new CloseEvent(code, message, target));\n  }\n\n  function onError (event) {\n    event.type = 'error';\n    event.target = target;\n    listener.call(target, event);\n  }\n\n  function onOpen () {\n    listener.call(target, new OpenEvent(target));\n  }\n\n  if (typeof listener === 'function') {\n    if (method === 'message') {\n      // store a reference so we can return the original function from the\n      // addEventListener hook\n      onMessage._listener = listener;\n      this.on(method, onMessage);\n    } else if (method === 'close') {\n      // store a reference so we can return the original function from the\n      // addEventListener hook\n      onClose._listener = listener;\n      this.on(method, onClose);\n    } else if (method === 'error') {\n      // store a reference so we can return the original function from the\n      // addEventListener hook\n      onError._listener = listener;\n      this.on(method, onError);\n    } else if (method === 'open') {\n      // store a reference so we can return the original function from the\n      // addEventListener hook\n      onOpen._listener = listener;\n      this.on(method, onOpen);\n    } else {\n      this.on(method, listener);\n    }\n  }\n};\n\nmodule.exports = WebSocket;\nmodule.exports.buildHostHeader = buildHostHeader\n\n/**\n * W3C MessageEvent\n *\n * @see http://www.w3.org/TR/html5/comms.html\n * @constructor\n * @api private\n */\nfunction MessageEvent(dataArg, isBinary, target) {\n  this.type = 'message';\n  this.data = dataArg;\n  this.target = target;\n  this.binary = isBinary; // non-standard.\n}\n\n/**\n * W3C CloseEvent\n *\n * @see http://www.w3.org/TR/html5/comms.html\n * @constructor\n * @api private\n */\nfunction CloseEvent(code, reason, target) {\n  this.type = 'close';\n  this.wasClean = (typeof code === 'undefined' || code === 1000);\n  this.code = code;\n  this.reason = reason;\n  this.target = target;\n}\n\n/**\n * W3C OpenEvent\n *\n * @see http://www.w3.org/TR/html5/comms.html\n * @constructor\n * @api private\n */\nfunction OpenEvent(target) {\n  this.type = 'open';\n  this.target = target;\n}\n\n// Append port number to Host header, only if specified in the url\n// and non-default\nfunction buildHostHeader(isSecure, hostname, port) {\n  var headerHost = hostname;\n  if (hostname) {\n    if ((isSecure && (port != 443)) || (!isSecure && (port != 80))){\n      headerHost = headerHost + ':' + port;\n    }\n  }\n  return headerHost;\n}\n\n/**\n * Entirely private apis,\n * which may or may not be bound to a sepcific WebSocket instance.\n */\nfunction initAsServerClient(req, socket, upgradeHead, options) {\n  options = new Options({\n    protocolVersion: protocolVersion,\n    protocol: null,\n    extensions: {},\n    maxPayload: 0\n  }).merge(options);\n\n  // expose state properties\n  this.protocol = options.value.protocol;\n  this.protocolVersion = options.value.protocolVersion;\n  this.extensions = options.value.extensions;\n  this.supports.binary = (this.protocolVersion !== 'hixie-76');\n  this.upgradeReq = req;\n  this.readyState = WebSocket.CONNECTING;\n  this._isServer = true;\n  this.maxPayload = options.value.maxPayload;\n  // establish connection\n  if (options.value.protocolVersion === 'hixie-76') {\n    establishConnection.call(this, ReceiverHixie, SenderHixie, socket, upgradeHead);\n  } else {\n    establishConnection.call(this, Receiver, Sender, socket, upgradeHead);\n  }\n}\n\nfunction initAsClient(address, protocols, options) {\n  options = new Options({\n    origin: null,\n    protocolVersion: protocolVersion,\n    host: null,\n    headers: null,\n    protocol: protocols.join(','),\n    agent: null,\n\n    // ssl-related options\n    pfx: null,\n    key: null,\n    passphrase: null,\n    cert: null,\n    ca: null,\n    ciphers: null,\n    rejectUnauthorized: null,\n    perMessageDeflate: true,\n    localAddress: null\n  }).merge(options);\n\n  if (options.value.protocolVersion !== 8 && options.value.protocolVersion !== 13) {\n    throw new Error('unsupported protocol version');\n  }\n\n  // verify URL and establish http class\n  var serverUrl = url.parse(address);\n  var isUnixSocket = serverUrl.protocol === 'ws+unix:';\n  if (!serverUrl.host && !isUnixSocket) throw new Error('invalid url');\n  var isSecure = serverUrl.protocol === 'wss:' || serverUrl.protocol === 'https:';\n  var httpObj = isSecure ? https : http;\n  var port = serverUrl.port || (isSecure ? 443 : 80);\n  var auth = serverUrl.auth;\n\n  // prepare extensions\n  var extensionsOffer = {};\n  var perMessageDeflate;\n  if (options.value.perMessageDeflate) {\n    perMessageDeflate = new PerMessageDeflate(typeof options.value.perMessageDeflate !== true ? options.value.perMessageDeflate : {}, false);\n    extensionsOffer[PerMessageDeflate.extensionName] = perMessageDeflate.offer();\n  }\n\n  // expose state properties\n  this._isServer = false;\n  this.url = address;\n  this.protocolVersion = options.value.protocolVersion;\n  this.supports.binary = (this.protocolVersion !== 'hixie-76');\n\n  // begin handshake\n  var key = new Buffer(options.value.protocolVersion + '-' + Date.now()).toString('base64');\n  var shasum = crypto.createHash('sha1');\n  shasum.update(key + '258EAFA5-E914-47DA-95CA-C5AB0DC85B11');\n  var expectedServerKey = shasum.digest('base64');\n\n  var agent = options.value.agent;\n\n  var headerHost = buildHostHeader(isSecure, serverUrl.hostname, port)\n\n  var requestOptions = {\n    port: port,\n    host: serverUrl.hostname,\n    headers: {\n      'Connection': 'Upgrade',\n      'Upgrade': 'websocket',\n      'Host': headerHost,\n      'Sec-WebSocket-Version': options.value.protocolVersion,\n      'Sec-WebSocket-Key': key\n    }\n  };\n\n  // If we have basic auth.\n  if (auth) {\n    requestOptions.headers.Authorization = 'Basic ' + new Buffer(auth).toString('base64');\n  }\n\n  if (options.value.protocol) {\n    requestOptions.headers['Sec-WebSocket-Protocol'] = options.value.protocol;\n  }\n\n  if (options.value.host) {\n    requestOptions.headers.Host = options.value.host;\n  }\n\n  if (options.value.headers) {\n    for (var header in options.value.headers) {\n       if (options.value.headers.hasOwnProperty(header)) {\n        requestOptions.headers[header] = options.value.headers[header];\n       }\n    }\n  }\n\n  if (Object.keys(extensionsOffer).length) {\n    requestOptions.headers['Sec-WebSocket-Extensions'] = Extensions.format(extensionsOffer);\n  }\n\n  if (options.isDefinedAndNonNull('pfx')\n   || options.isDefinedAndNonNull('key')\n   || options.isDefinedAndNonNull('passphrase')\n   || options.isDefinedAndNonNull('cert')\n   || options.isDefinedAndNonNull('ca')\n   || options.isDefinedAndNonNull('ciphers')\n   || options.isDefinedAndNonNull('rejectUnauthorized')) {\n\n    if (options.isDefinedAndNonNull('pfx')) requestOptions.pfx = options.value.pfx;\n    if (options.isDefinedAndNonNull('key')) requestOptions.key = options.value.key;\n    if (options.isDefinedAndNonNull('passphrase')) requestOptions.passphrase = options.value.passphrase;\n    if (options.isDefinedAndNonNull('cert')) requestOptions.cert = options.value.cert;\n    if (options.isDefinedAndNonNull('ca')) requestOptions.ca = options.value.ca;\n    if (options.isDefinedAndNonNull('ciphers')) requestOptions.ciphers = options.value.ciphers;\n    if (options.isDefinedAndNonNull('rejectUnauthorized')) requestOptions.rejectUnauthorized = options.value.rejectUnauthorized;\n\n    if (!agent) {\n        // global agent ignores client side certificates\n        agent = new httpObj.Agent(requestOptions);\n    }\n  }\n\n  requestOptions.path = serverUrl.path || '/';\n\n  if (agent) {\n    requestOptions.agent = agent;\n  }\n\n  if (isUnixSocket) {\n    requestOptions.socketPath = serverUrl.pathname;\n  }\n\n  if (options.value.localAddress) {\n    requestOptions.localAddress = options.value.localAddress;\n  }\n\n  if (options.value.origin) {\n    if (options.value.protocolVersion < 13) requestOptions.headers['Sec-WebSocket-Origin'] = options.value.origin;\n    else requestOptions.headers.Origin = options.value.origin;\n  }\n\n  var self = this;\n  var req = httpObj.request(requestOptions);\n\n  req.on('error', function onerror(error) {\n    self.emit('error', error);\n    cleanupWebsocketResources.call(self, error);\n  });\n\n  req.once('response', function response(res) {\n    var error;\n\n    if (!self.emit('unexpected-response', req, res)) {\n      error = new Error('unexpected server response (' + res.statusCode + ')');\n      req.abort();\n      self.emit('error', error);\n    }\n\n    cleanupWebsocketResources.call(self, error);\n  });\n\n  req.once('upgrade', function upgrade(res, socket, upgradeHead) {\n    if (self.readyState === WebSocket.CLOSED) {\n      // client closed before server accepted connection\n      self.emit('close');\n      self.removeAllListeners();\n      socket.end();\n      return;\n    }\n\n    var serverKey = res.headers['sec-websocket-accept'];\n    if (typeof serverKey === 'undefined' || serverKey !== expectedServerKey) {\n      self.emit('error', 'invalid server key');\n      self.removeAllListeners();\n      socket.end();\n      return;\n    }\n\n    var serverProt = res.headers['sec-websocket-protocol'];\n    var protList = (options.value.protocol || \"\").split(/, */);\n    var protError = null;\n\n    if (!options.value.protocol && serverProt) {\n      protError = 'server sent a subprotocol even though none requested';\n    } else if (options.value.protocol && !serverProt) {\n      protError = 'server sent no subprotocol even though requested';\n    } else if (serverProt && protList.indexOf(serverProt) === -1) {\n      protError = 'server responded with an invalid protocol';\n    }\n\n    if (protError) {\n      self.emit('error', protError);\n      self.removeAllListeners();\n      socket.end();\n      return;\n    } else if (serverProt) {\n      self.protocol = serverProt;\n    }\n\n    var serverExtensions = Extensions.parse(res.headers['sec-websocket-extensions']);\n    if (perMessageDeflate && serverExtensions[PerMessageDeflate.extensionName]) {\n      try {\n        perMessageDeflate.accept(serverExtensions[PerMessageDeflate.extensionName]);\n      } catch (err) {\n        self.emit('error', 'invalid extension parameter');\n        self.removeAllListeners();\n        socket.end();\n        return;\n      }\n      self.extensions[PerMessageDeflate.extensionName] = perMessageDeflate;\n    }\n\n    establishConnection.call(self, Receiver, Sender, socket, upgradeHead);\n\n    // perform cleanup on http resources\n    req.removeAllListeners();\n    req = null;\n    agent = null;\n  });\n\n  req.end();\n  this.readyState = WebSocket.CONNECTING;\n}\n\nfunction establishConnection(ReceiverClass, SenderClass, socket, upgradeHead) {\n  var ultron = this._ultron = new Ultron(socket)\n    , called = false\n    , self = this;\n\n  socket.setTimeout(0);\n  socket.setNoDelay(true);\n\n  this._receiver = new ReceiverClass(this.extensions,this.maxPayload);\n  this._socket = socket;\n\n  // socket cleanup handlers\n  ultron.on('end', cleanupWebsocketResources.bind(this));\n  ultron.on('close', cleanupWebsocketResources.bind(this));\n  ultron.on('error', cleanupWebsocketResources.bind(this));\n\n  // ensure that the upgradeHead is added to the receiver\n  function firstHandler(data) {\n    if (called || self.readyState === WebSocket.CLOSED) return;\n\n    called = true;\n    socket.removeListener('data', firstHandler);\n    ultron.on('data', realHandler);\n\n    if (upgradeHead && upgradeHead.length > 0) {\n      realHandler(upgradeHead);\n      upgradeHead = null;\n    }\n\n    if (data) realHandler(data);\n  }\n\n  // subsequent packets are pushed straight to the receiver\n  function realHandler(data) {\n    self.bytesReceived += data.length;\n    self._receiver.add(data);\n  }\n\n  ultron.on('data', firstHandler);\n\n  // if data was passed along with the http upgrade,\n  // this will schedule a push of that on to the receiver.\n  // this has to be done on next tick, since the caller\n  // hasn't had a chance to set event handlers on this client\n  // object yet.\n  process.nextTick(firstHandler);\n\n  // receiver event handlers\n  self._receiver.ontext = function ontext(data, flags) {\n    flags = flags || {};\n\n    self.emit('message', data, flags);\n  };\n\n  self._receiver.onbinary = function onbinary(data, flags) {\n    flags = flags || {};\n\n    flags.binary = true;\n    self.emit('message', data, flags);\n  };\n\n  self._receiver.onping = function onping(data, flags) {\n    flags = flags || {};\n\n    self.pong(data, {\n      mask: !self._isServer,\n      binary: flags.binary === true\n    }, true);\n\n    self.emit('ping', data, flags);\n  };\n\n  self._receiver.onpong = function onpong(data, flags) {\n    self.emit('pong', data, flags || {});\n  };\n\n  self._receiver.onclose = function onclose(code, data, flags) {\n    flags = flags || {};\n\n    self._closeReceived = true;\n    self.close(code, data);\n  };\n\n  self._receiver.onerror = function onerror(reason, errorCode) {\n    // close the connection when the receiver reports a HyBi error code\n    self.close(typeof errorCode !== 'undefined' ? errorCode : 1002, '');\n    self.emit('error', (reason instanceof Error) ? reason : (new Error(reason)));\n  };\n\n  // finalize the client\n  this._sender = new SenderClass(socket, this.extensions);\n  this._sender.on('error', function onerror(error) {\n    self.close(1002, '');\n    self.emit('error', error);\n  });\n\n  this.readyState = WebSocket.OPEN;\n  this.emit('open');\n}\n\nfunction startQueue(instance) {\n  instance._queue = instance._queue || [];\n}\n\nfunction executeQueueSends(instance) {\n  var queue = instance._queue;\n  if (typeof queue === 'undefined') return;\n\n  delete instance._queue;\n  for (var i = 0, l = queue.length; i < l; ++i) {\n    queue[i]();\n  }\n}\n\nfunction sendStream(instance, stream, options, cb) {\n  stream.on('data', function incoming(data) {\n    if (instance.readyState !== WebSocket.OPEN) {\n      if (typeof cb === 'function') cb(new Error('not opened'));\n      else {\n        delete instance._queue;\n        instance.emit('error', new Error('not opened'));\n      }\n      return;\n    }\n\n    options.fin = false;\n    instance._sender.send(data, options);\n  });\n\n  stream.on('end', function end() {\n    if (instance.readyState !== WebSocket.OPEN) {\n      if (typeof cb === 'function') cb(new Error('not opened'));\n      else {\n        delete instance._queue;\n        instance.emit('error', new Error('not opened'));\n      }\n      return;\n    }\n\n    options.fin = true;\n    instance._sender.send(null, options);\n\n    if (typeof cb === 'function') cb(null);\n  });\n}\n\nfunction cleanupWebsocketResources(error) {\n  if (this.readyState === WebSocket.CLOSED) return;\n\n  this.readyState = WebSocket.CLOSED;\n\n  clearTimeout(this._closeTimer);\n  this._closeTimer = null;\n\n  // If the connection was closed abnormally (with an error), or if\n  // the close control frame was not received then the close code\n  // must default to 1006.\n  if (error || !this._closeReceived) {\n    this._closeCode = 1006;\n  }\n  this.emit('close', this._closeCode || 1000, this._closeMessage || '');\n\n  if (this._socket) {\n    if (this._ultron) this._ultron.destroy();\n    this._socket.on('error', function onerror() {\n      try { this.destroy(); }\n      catch (e) {}\n    });\n\n    try {\n      if (!error) this._socket.end();\n      else this._socket.destroy();\n    } catch (e) { /* Ignore termination errors */ }\n\n    this._socket = null;\n    this._ultron = null;\n  }\n\n  if (this._sender) {\n    this._sender.removeAllListeners();\n    this._sender = null;\n  }\n\n  if (this._receiver) {\n    this._receiver.cleanup();\n    this._receiver = null;\n  }\n\n  if (this.extensions[PerMessageDeflate.extensionName]) {\n    this.extensions[PerMessageDeflate.extensionName].cleanup();\n  }\n\n  this.extensions = null;\n\n  this.removeAllListeners();\n  this.on('error', function onerror() {}); // catch all errors after this\n  delete this._queue;\n}\n"]},"metadata":{},"sourceType":"script"}