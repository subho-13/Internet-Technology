{"ast":null,"code":"var zlib = require('zlib');\n\nvar AVAILABLE_WINDOW_BITS = [8, 9, 10, 11, 12, 13, 14, 15];\nvar DEFAULT_WINDOW_BITS = 15;\nvar DEFAULT_MEM_LEVEL = 8;\nPerMessageDeflate.extensionName = 'permessage-deflate';\n/**\n * Per-message Compression Extensions implementation\n */\n\nfunction PerMessageDeflate(options, isServer, maxPayload) {\n  if (this instanceof PerMessageDeflate === false) {\n    throw new TypeError(\"Classes can't be function-called\");\n  }\n\n  this._options = options || {};\n  this._isServer = !!isServer;\n  this._inflate = null;\n  this._deflate = null;\n  this.params = null;\n  this._maxPayload = maxPayload || 0;\n}\n/**\n * Create extension parameters offer\n *\n * @api public\n */\n\n\nPerMessageDeflate.prototype.offer = function () {\n  var params = {};\n\n  if (this._options.serverNoContextTakeover) {\n    params.server_no_context_takeover = true;\n  }\n\n  if (this._options.clientNoContextTakeover) {\n    params.client_no_context_takeover = true;\n  }\n\n  if (this._options.serverMaxWindowBits) {\n    params.server_max_window_bits = this._options.serverMaxWindowBits;\n  }\n\n  if (this._options.clientMaxWindowBits) {\n    params.client_max_window_bits = this._options.clientMaxWindowBits;\n  } else if (this._options.clientMaxWindowBits == null) {\n    params.client_max_window_bits = true;\n  }\n\n  return params;\n};\n/**\n * Accept extension offer\n *\n * @api public\n */\n\n\nPerMessageDeflate.prototype.accept = function (paramsList) {\n  paramsList = this.normalizeParams(paramsList);\n  var params;\n\n  if (this._isServer) {\n    params = this.acceptAsServer(paramsList);\n  } else {\n    params = this.acceptAsClient(paramsList);\n  }\n\n  this.params = params;\n  return params;\n};\n/**\n * Releases all resources used by the extension\n *\n * @api public\n */\n\n\nPerMessageDeflate.prototype.cleanup = function () {\n  if (this._inflate) {\n    if (this._inflate.writeInProgress) {\n      this._inflate.pendingClose = true;\n    } else {\n      if (this._inflate.close) this._inflate.close();\n      this._inflate = null;\n    }\n  }\n\n  if (this._deflate) {\n    if (this._deflate.writeInProgress) {\n      this._deflate.pendingClose = true;\n    } else {\n      if (this._deflate.close) this._deflate.close();\n      this._deflate = null;\n    }\n  }\n};\n/**\n * Accept extension offer from client\n *\n * @api private\n */\n\n\nPerMessageDeflate.prototype.acceptAsServer = function (paramsList) {\n  var accepted = {};\n  var result = paramsList.some(function (params) {\n    accepted = {};\n\n    if (this._options.serverNoContextTakeover === false && params.server_no_context_takeover) {\n      return;\n    }\n\n    if (this._options.serverMaxWindowBits === false && params.server_max_window_bits) {\n      return;\n    }\n\n    if (typeof this._options.serverMaxWindowBits === 'number' && typeof params.server_max_window_bits === 'number' && this._options.serverMaxWindowBits > params.server_max_window_bits) {\n      return;\n    }\n\n    if (typeof this._options.clientMaxWindowBits === 'number' && !params.client_max_window_bits) {\n      return;\n    }\n\n    if (this._options.serverNoContextTakeover || params.server_no_context_takeover) {\n      accepted.server_no_context_takeover = true;\n    }\n\n    if (this._options.clientNoContextTakeover) {\n      accepted.client_no_context_takeover = true;\n    }\n\n    if (this._options.clientNoContextTakeover !== false && params.client_no_context_takeover) {\n      accepted.client_no_context_takeover = true;\n    }\n\n    if (typeof this._options.serverMaxWindowBits === 'number') {\n      accepted.server_max_window_bits = this._options.serverMaxWindowBits;\n    } else if (typeof params.server_max_window_bits === 'number') {\n      accepted.server_max_window_bits = params.server_max_window_bits;\n    }\n\n    if (typeof this._options.clientMaxWindowBits === 'number') {\n      accepted.client_max_window_bits = this._options.clientMaxWindowBits;\n    } else if (this._options.clientMaxWindowBits !== false && typeof params.client_max_window_bits === 'number') {\n      accepted.client_max_window_bits = params.client_max_window_bits;\n    }\n\n    return true;\n  }, this);\n\n  if (!result) {\n    throw new Error('Doesn\\'t support the offered configuration');\n  }\n\n  return accepted;\n};\n/**\n * Accept extension response from server\n *\n * @api privaye\n */\n\n\nPerMessageDeflate.prototype.acceptAsClient = function (paramsList) {\n  var params = paramsList[0];\n\n  if (this._options.clientNoContextTakeover != null) {\n    if (this._options.clientNoContextTakeover === false && params.client_no_context_takeover) {\n      throw new Error('Invalid value for \"client_no_context_takeover\"');\n    }\n  }\n\n  if (this._options.clientMaxWindowBits != null) {\n    if (this._options.clientMaxWindowBits === false && params.client_max_window_bits) {\n      throw new Error('Invalid value for \"client_max_window_bits\"');\n    }\n\n    if (typeof this._options.clientMaxWindowBits === 'number' && (!params.client_max_window_bits || params.client_max_window_bits > this._options.clientMaxWindowBits)) {\n      throw new Error('Invalid value for \"client_max_window_bits\"');\n    }\n  }\n\n  return params;\n};\n/**\n * Normalize extensions parameters\n *\n * @api private\n */\n\n\nPerMessageDeflate.prototype.normalizeParams = function (paramsList) {\n  return paramsList.map(function (params) {\n    Object.keys(params).forEach(function (key) {\n      var value = params[key];\n\n      if (value.length > 1) {\n        throw new Error('Multiple extension parameters for ' + key);\n      }\n\n      value = value[0];\n\n      switch (key) {\n        case 'server_no_context_takeover':\n        case 'client_no_context_takeover':\n          if (value !== true) {\n            throw new Error('invalid extension parameter value for ' + key + ' (' + value + ')');\n          }\n\n          params[key] = true;\n          break;\n\n        case 'server_max_window_bits':\n        case 'client_max_window_bits':\n          if (typeof value === 'string') {\n            value = parseInt(value, 10);\n\n            if (!~AVAILABLE_WINDOW_BITS.indexOf(value)) {\n              throw new Error('invalid extension parameter value for ' + key + ' (' + value + ')');\n            }\n          }\n\n          if (!this._isServer && value === true) {\n            throw new Error('Missing extension parameter value for ' + key);\n          }\n\n          params[key] = value;\n          break;\n\n        default:\n          throw new Error('Not defined extension parameter (' + key + ')');\n      }\n    }, this);\n    return params;\n  }, this);\n};\n/**\n * Decompress message\n *\n * @api public\n */\n\n\nPerMessageDeflate.prototype.decompress = function (data, fin, callback) {\n  var endpoint = this._isServer ? 'client' : 'server';\n\n  if (!this._inflate) {\n    var maxWindowBits = this.params[endpoint + '_max_window_bits'];\n    this._inflate = zlib.createInflateRaw({\n      windowBits: 'number' === typeof maxWindowBits ? maxWindowBits : DEFAULT_WINDOW_BITS\n    });\n  }\n\n  this._inflate.writeInProgress = true;\n  var self = this;\n  var buffers = [];\n  var cumulativeBufferLength = 0;\n\n  this._inflate.on('error', onError).on('data', onData);\n\n  this._inflate.write(data);\n\n  if (fin) {\n    this._inflate.write(new Buffer([0x00, 0x00, 0xff, 0xff]));\n  }\n\n  this._inflate.flush(function () {\n    cleanup();\n    callback(null, Buffer.concat(buffers));\n  });\n\n  function onError(err) {\n    cleanup();\n    callback(err);\n  }\n\n  function onData(data) {\n    if (self._maxPayload !== undefined && self._maxPayload !== null && self._maxPayload > 0) {\n      cumulativeBufferLength += data.length;\n\n      if (cumulativeBufferLength > self._maxPayload) {\n        buffers = [];\n        cleanup();\n        var err = {\n          type: 1009\n        };\n        callback(err);\n        return;\n      }\n    }\n\n    buffers.push(data);\n  }\n\n  function cleanup() {\n    if (!self._inflate) return;\n\n    self._inflate.removeListener('error', onError);\n\n    self._inflate.removeListener('data', onData);\n\n    self._inflate.writeInProgress = false;\n\n    if (fin && self.params[endpoint + '_no_context_takeover'] || self._inflate.pendingClose) {\n      if (self._inflate.close) self._inflate.close();\n      self._inflate = null;\n    }\n  }\n};\n/**\n * Compress message\n *\n * @api public\n */\n\n\nPerMessageDeflate.prototype.compress = function (data, fin, callback) {\n  var endpoint = this._isServer ? 'server' : 'client';\n\n  if (!this._deflate) {\n    var maxWindowBits = this.params[endpoint + '_max_window_bits'];\n    this._deflate = zlib.createDeflateRaw({\n      flush: zlib.Z_SYNC_FLUSH,\n      windowBits: 'number' === typeof maxWindowBits ? maxWindowBits : DEFAULT_WINDOW_BITS,\n      memLevel: this._options.memLevel || DEFAULT_MEM_LEVEL\n    });\n  }\n\n  this._deflate.writeInProgress = true;\n  var self = this;\n  var buffers = [];\n\n  this._deflate.on('error', onError).on('data', onData);\n\n  this._deflate.write(data);\n\n  this._deflate.flush(function () {\n    cleanup();\n    var data = Buffer.concat(buffers);\n\n    if (fin) {\n      data = data.slice(0, data.length - 4);\n    }\n\n    callback(null, data);\n  });\n\n  function onError(err) {\n    cleanup();\n    callback(err);\n  }\n\n  function onData(data) {\n    buffers.push(data);\n  }\n\n  function cleanup() {\n    if (!self._deflate) return;\n\n    self._deflate.removeListener('error', onError);\n\n    self._deflate.removeListener('data', onData);\n\n    self._deflate.writeInProgress = false;\n\n    if (fin && self.params[endpoint + '_no_context_takeover'] || self._deflate.pendingClose) {\n      if (self._deflate.close) self._deflate.close();\n      self._deflate = null;\n    }\n  }\n};\n\nmodule.exports = PerMessageDeflate;","map":{"version":3,"sources":["/home/subho/Programming/Internet-Technology/Athena/node_modules/ws/lib/PerMessageDeflate.js"],"names":["zlib","require","AVAILABLE_WINDOW_BITS","DEFAULT_WINDOW_BITS","DEFAULT_MEM_LEVEL","PerMessageDeflate","extensionName","options","isServer","maxPayload","TypeError","_options","_isServer","_inflate","_deflate","params","_maxPayload","prototype","offer","serverNoContextTakeover","server_no_context_takeover","clientNoContextTakeover","client_no_context_takeover","serverMaxWindowBits","server_max_window_bits","clientMaxWindowBits","client_max_window_bits","accept","paramsList","normalizeParams","acceptAsServer","acceptAsClient","cleanup","writeInProgress","pendingClose","close","accepted","result","some","Error","map","Object","keys","forEach","key","value","length","parseInt","indexOf","decompress","data","fin","callback","endpoint","maxWindowBits","createInflateRaw","windowBits","self","buffers","cumulativeBufferLength","on","onError","onData","write","Buffer","flush","concat","err","undefined","type","push","removeListener","compress","createDeflateRaw","Z_SYNC_FLUSH","memLevel","slice","module","exports"],"mappings":"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","sourcesContent":["\nvar zlib = require('zlib');\n\nvar AVAILABLE_WINDOW_BITS = [8, 9, 10, 11, 12, 13, 14, 15];\nvar DEFAULT_WINDOW_BITS = 15;\nvar DEFAULT_MEM_LEVEL = 8;\n\nPerMessageDeflate.extensionName = 'permessage-deflate';\n\n/**\n * Per-message Compression Extensions implementation\n */\n\nfunction PerMessageDeflate(options, isServer,maxPayload) {\n  if (this instanceof PerMessageDeflate === false) {\n    throw new TypeError(\"Classes can't be function-called\");\n  }\n\n  this._options = options || {};\n  this._isServer = !!isServer;\n  this._inflate = null;\n  this._deflate = null;\n  this.params = null;\n  this._maxPayload = maxPayload || 0;\n}\n\n/**\n * Create extension parameters offer\n *\n * @api public\n */\n\nPerMessageDeflate.prototype.offer = function() {\n  var params = {};\n  if (this._options.serverNoContextTakeover) {\n    params.server_no_context_takeover = true;\n  }\n  if (this._options.clientNoContextTakeover) {\n    params.client_no_context_takeover = true;\n  }\n  if (this._options.serverMaxWindowBits) {\n    params.server_max_window_bits = this._options.serverMaxWindowBits;\n  }\n  if (this._options.clientMaxWindowBits) {\n    params.client_max_window_bits = this._options.clientMaxWindowBits;\n  } else if (this._options.clientMaxWindowBits == null) {\n    params.client_max_window_bits = true;\n  }\n  return params;\n};\n\n/**\n * Accept extension offer\n *\n * @api public\n */\n\nPerMessageDeflate.prototype.accept = function(paramsList) {\n  paramsList = this.normalizeParams(paramsList);\n\n  var params;\n  if (this._isServer) {\n    params = this.acceptAsServer(paramsList);\n  } else {\n    params = this.acceptAsClient(paramsList);\n  }\n\n  this.params = params;\n  return params;\n};\n\n/**\n * Releases all resources used by the extension\n *\n * @api public\n */\n\nPerMessageDeflate.prototype.cleanup = function() {\n  if (this._inflate) {\n    if (this._inflate.writeInProgress) {\n      this._inflate.pendingClose = true;\n    } else {\n      if (this._inflate.close) this._inflate.close();\n      this._inflate = null;\n    }\n  }\n  if (this._deflate) {\n    if (this._deflate.writeInProgress) {\n      this._deflate.pendingClose = true;\n    } else {\n      if (this._deflate.close) this._deflate.close();\n      this._deflate = null;\n    }\n  }\n};\n\n/**\n * Accept extension offer from client\n *\n * @api private\n */\n\nPerMessageDeflate.prototype.acceptAsServer = function(paramsList) {\n  var accepted = {};\n  var result = paramsList.some(function(params) {\n    accepted = {};\n    if (this._options.serverNoContextTakeover === false && params.server_no_context_takeover) {\n      return;\n    }\n    if (this._options.serverMaxWindowBits === false && params.server_max_window_bits) {\n      return;\n    }\n    if (typeof this._options.serverMaxWindowBits === 'number' &&\n        typeof params.server_max_window_bits === 'number' &&\n        this._options.serverMaxWindowBits > params.server_max_window_bits) {\n      return;\n    }\n    if (typeof this._options.clientMaxWindowBits === 'number' && !params.client_max_window_bits) {\n      return;\n    }\n\n    if (this._options.serverNoContextTakeover || params.server_no_context_takeover) {\n      accepted.server_no_context_takeover = true;\n    }\n    if (this._options.clientNoContextTakeover) {\n      accepted.client_no_context_takeover = true;\n    }\n    if (this._options.clientNoContextTakeover !== false && params.client_no_context_takeover) {\n      accepted.client_no_context_takeover = true;\n    }\n    if (typeof this._options.serverMaxWindowBits === 'number') {\n      accepted.server_max_window_bits = this._options.serverMaxWindowBits;\n    } else if (typeof params.server_max_window_bits === 'number') {\n      accepted.server_max_window_bits = params.server_max_window_bits;\n    }\n    if (typeof this._options.clientMaxWindowBits === 'number') {\n      accepted.client_max_window_bits = this._options.clientMaxWindowBits;\n    } else if (this._options.clientMaxWindowBits !== false && typeof params.client_max_window_bits === 'number') {\n      accepted.client_max_window_bits = params.client_max_window_bits;\n    }\n    return true;\n  }, this);\n\n  if (!result) {\n    throw new Error('Doesn\\'t support the offered configuration');\n  }\n\n  return accepted;\n};\n\n/**\n * Accept extension response from server\n *\n * @api privaye\n */\n\nPerMessageDeflate.prototype.acceptAsClient = function(paramsList) {\n  var params = paramsList[0];\n  if (this._options.clientNoContextTakeover != null) {\n    if (this._options.clientNoContextTakeover === false && params.client_no_context_takeover) {\n      throw new Error('Invalid value for \"client_no_context_takeover\"');\n    }\n  }\n  if (this._options.clientMaxWindowBits != null) {\n    if (this._options.clientMaxWindowBits === false && params.client_max_window_bits) {\n      throw new Error('Invalid value for \"client_max_window_bits\"');\n    }\n    if (typeof this._options.clientMaxWindowBits === 'number' &&\n        (!params.client_max_window_bits || params.client_max_window_bits > this._options.clientMaxWindowBits)) {\n      throw new Error('Invalid value for \"client_max_window_bits\"');\n    }\n  }\n  return params;\n};\n\n/**\n * Normalize extensions parameters\n *\n * @api private\n */\n\nPerMessageDeflate.prototype.normalizeParams = function(paramsList) {\n  return paramsList.map(function(params) {\n    Object.keys(params).forEach(function(key) {\n      var value = params[key];\n      if (value.length > 1) {\n        throw new Error('Multiple extension parameters for ' + key);\n      }\n\n      value = value[0];\n\n      switch (key) {\n      case 'server_no_context_takeover':\n      case 'client_no_context_takeover':\n        if (value !== true) {\n          throw new Error('invalid extension parameter value for ' + key + ' (' + value + ')');\n        }\n        params[key] = true;\n        break;\n      case 'server_max_window_bits':\n      case 'client_max_window_bits':\n        if (typeof value === 'string') {\n          value = parseInt(value, 10);\n          if (!~AVAILABLE_WINDOW_BITS.indexOf(value)) {\n            throw new Error('invalid extension parameter value for ' + key + ' (' + value + ')');\n          }\n        }\n        if (!this._isServer && value === true) {\n          throw new Error('Missing extension parameter value for ' + key);\n        }\n        params[key] = value;\n        break;\n      default:\n        throw new Error('Not defined extension parameter (' + key + ')');\n      }\n    }, this);\n    return params;\n  }, this);\n};\n\n/**\n * Decompress message\n *\n * @api public\n */\n\nPerMessageDeflate.prototype.decompress = function (data, fin, callback) {\n  var endpoint = this._isServer ? 'client' : 'server';\n\n  if (!this._inflate) {\n    var maxWindowBits = this.params[endpoint + '_max_window_bits'];\n    this._inflate = zlib.createInflateRaw({\n      windowBits: 'number' === typeof maxWindowBits ? maxWindowBits : DEFAULT_WINDOW_BITS\n    });\n  }\n  this._inflate.writeInProgress = true;\n\n  var self = this;\n  var buffers = [];\n  var cumulativeBufferLength=0;\n\n  this._inflate.on('error', onError).on('data', onData);\n  this._inflate.write(data);\n  if (fin) {\n    this._inflate.write(new Buffer([0x00, 0x00, 0xff, 0xff]));\n  }\n  this._inflate.flush(function() {\n    cleanup();\n    callback(null, Buffer.concat(buffers));\n  });\n\n  function onError(err) {\n    cleanup();\n    callback(err);\n  }\n\n  function onData(data) {\n      if(self._maxPayload!==undefined && self._maxPayload!==null && self._maxPayload>0){\n          cumulativeBufferLength+=data.length;\n          if(cumulativeBufferLength>self._maxPayload){\n            buffers=[];\n            cleanup();\n            var err={type:1009};\n            callback(err);\n            return;\n          }\n      }\n      buffers.push(data);\n  }\n\n  function cleanup() {\n    if (!self._inflate) return;\n    self._inflate.removeListener('error', onError);\n    self._inflate.removeListener('data', onData);\n    self._inflate.writeInProgress = false;\n    if ((fin && self.params[endpoint + '_no_context_takeover']) || self._inflate.pendingClose) {\n      if (self._inflate.close) self._inflate.close();\n      self._inflate = null;\n    }\n  }\n};\n\n/**\n * Compress message\n *\n * @api public\n */\n\nPerMessageDeflate.prototype.compress = function (data, fin, callback) {\n  var endpoint = this._isServer ? 'server' : 'client';\n\n  if (!this._deflate) {\n    var maxWindowBits = this.params[endpoint + '_max_window_bits'];\n    this._deflate = zlib.createDeflateRaw({\n      flush: zlib.Z_SYNC_FLUSH,\n      windowBits: 'number' === typeof maxWindowBits ? maxWindowBits : DEFAULT_WINDOW_BITS,\n      memLevel: this._options.memLevel || DEFAULT_MEM_LEVEL\n    });\n  }\n  this._deflate.writeInProgress = true;\n\n  var self = this;\n  var buffers = [];\n\n  this._deflate.on('error', onError).on('data', onData);\n  this._deflate.write(data);\n  this._deflate.flush(function() {\n    cleanup();\n    var data = Buffer.concat(buffers);\n    if (fin) {\n      data = data.slice(0, data.length - 4);\n    }\n    callback(null, data);\n  });\n\n  function onError(err) {\n    cleanup();\n    callback(err);\n  }\n\n  function onData(data) {\n    buffers.push(data);\n  }\n\n  function cleanup() {\n    if (!self._deflate) return;\n    self._deflate.removeListener('error', onError);\n    self._deflate.removeListener('data', onData);\n    self._deflate.writeInProgress = false;\n    if ((fin && self.params[endpoint + '_no_context_takeover']) || self._deflate.pendingClose) {\n      if (self._deflate.close) self._deflate.close();\n      self._deflate = null;\n    }\n  }\n};\n\nmodule.exports = PerMessageDeflate;\n"]},"metadata":{},"sourceType":"script"}